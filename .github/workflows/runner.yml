name: build network 

on:
  push:
    branches: [ main ]

env:
  APP_DIR: ./network_builder

jobs:
  lint_code:
    runs-on: self-hosted
    container:
      image: anttof/network-builder:latest

    steps: 
     - name: Check out this repository  
       uses: actions/checkout@v2

     - name: Simple Bash test 
       shell: bash
       run: |
          ls -ahl

     - name: Black Python Code Lint 
       run: black . --check

     - name: Isort Python Import Sort
       run: isort . --profile black --check


  test_code:
    runs-on: self-hosted
    container:
      image: anttof/network-builder:latest

    steps: 
     - name: Check out this repository  
       uses: actions/checkout@v2

     - name: Simple Bash test 
       working-directory: ${{ env.APP_DIR }}
       shell: bash
       run: ls -ahl

     - name: Test Jinja2 Filters
       working-directory: ${{ env.APP_DIR }}
       run: python -m unittest tests.test_filters -v

      #  python -m unittest discover -s tests -v
     - name: Test Network Builder
       working-directory: ${{ env.APP_DIR }}
       run: python -m unittest tests.test_network_builder -v

  build_configs:
    runs-on: self-hosted
    needs: [lint_code, test_code]
    container:
      image: anttof/network-builder:latest

    steps: 
     - name: Check out this repository  
       uses: actions/checkout@v2

     - name: generate_configs 
       working-directory: ${{ env.APP_DIR }}
       run: ./network_builder.py


  test_configs:
    runs-on: self-hosted
    needs: [build_configs]

    steps: 

     - name: install pybatfish 
       run: pip install pybatfish rich

     - name: Test Configuration via Batfish 
       run: batfish/test_configs.py --disable-pytest-warnings -s

       # Commit changes to repository if they succeed
     #- name: Commit and push if it changed
     #  run: |-
     #   git config user.name "Automated"
     #   git config user.email "actions@users.noreply.github.com"
     #   git add -A
     #   timestamp=$(date -u)
     #   git commit -m "Latest data: ${timestamp}" || exit 0
     #   git push

  deploy_configs:
    runs-on: self-hosted
    needs: [test_configs]
    container:
      image: anttof/network-builder:latest

    steps: 
     - name: Check out this repository  
       uses: actions/checkout@v2

     - name: deploy_configs
       working-directory: ${{ env.APP_DIR }}
       run: ./network_builder.py
       env:
         SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
         SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}